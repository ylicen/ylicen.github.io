{% extends "base.html" %}
{% block title %}管理后台{% endblock %}

{% block content %}
<div class="container mx-auto p-8 pt-24">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-4xl font-playfair-display">管理后台</h1>
        <a href="{{ url_for('logout') }}" class="bg-red-500 text-white font-bold py-2 px-4 rounded hover:bg-red-600 transition-colors">登出</a>
    </div>

    <div class="bg-white p-8 rounded-xl shadow-lg">
        <h2 class="text-2xl font-bold mb-6">所有预定</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-800 text-white">
                    <tr>
                        <th class="w-1/6 text-left py-3 px-4 uppercase font-semibold text-sm">预定码</th>
                        <th class="w-1/6 text-left py-3 px-4 uppercase font-semibold text-sm">顾客</th>
                        <th class="w-1/6 text-left py-3 px-4 uppercase font-semibold text-sm">邮箱</th>
                        <th class="w-1/6 text-left py-3 px-4 uppercase font-semibold text-sm">日期</th>
                        <th class="w-1/6 text-left py-3 px-4 uppercase font-semibold text-sm">总价</th>
                        <th class="text-left py-3 px-4 uppercase font-semibold text-sm">创建时间</th>
                        <th class="text-left py-3 px-4 uppercase font-semibold text-sm">操作</th>
                    </tr>
                </thead>
                <tbody class="text-gray-700">
                    {% for booking in bookings %}
                    <tr class="border-b">
                        <td class="py-3 px-4 font-mono">{{ booking.booking_code }}</td>
                        <td class="py-3 px-4">{{ booking.name }}</td>
                        <td class="py-3 px-4">{{ booking.email }}</td>
                        <td class="py-3 px-4">{{ booking.booking_date.strftime('%Y-%m-%d') }}</td>
                        <td class="py-3 px-4">¥{{ "%.2f"|format(booking.total_price * 7) }}</td>
                        <td class="py-3 px-4">{{ booking.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td class="py-3 px-4">
                            <button class="text-blue-500 hover:text-blue-700 font-semibold mr-4" onclick="openModal({{ booking.id }})">详情</button>
                            <form action="{{ url_for('delete_booking', booking_id=booking.id) }}" method="POST" onsubmit="return confirm('确定要删除这条预定吗？');" class="inline">
                                <button type="submit" class="text-red-500 hover:text-red-700 font-semibold">删除</button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center py-4">暂无预定记录。</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal -->
<div id="bookingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl transform transition-all" id="modalContent">
        <!-- Content will be injected by JavaScript -->
        <div class="p-8 text-center">
            <p>正在加载...</p>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const modal = document.getElementById('bookingModal');
    const modalContent = document.getElementById('modalContent');

    function openModal(bookingId) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        // Fetch booking details
        fetch(`/api/admin/booking/${bookingId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                let detailsHtml = data.details.map(detail => `
                    <tr class="border-b">
                        <td class="py-2 px-4">${detail.ticket_name}</td>
                        <td class="py-2 px-4">${detail.quantity}</td>
                        <td class="py-2 px-4">¥${(detail.price * 7).toFixed(2)}</td>
                        <td class="py-2 px-4">¥${(detail.quantity * detail.price * 7).toFixed(2)}</td>
                    </tr>
                `).join('');

                modalContent.innerHTML = `
                    <div class="p-6">
                        <div class="flex justify-between items-start">
                            <h3 class="text-2xl font-bold mb-4">预定详情</h3>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">&times;</button>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div><strong>预定码:</strong> ${data.booking_code}</div>
                            <div><strong>顾客姓名:</strong> ${data.name}</div>
                            <div><strong>邮箱:</strong> ${data.email}</div>
                            <div><strong>预定日期:</strong> ${data.booking_date}</div>
                            <div><strong>总价:</strong> <span class="font-bold text-lg">¥${(data.total_price * 7).toFixed(2)}</span></div>
                        </div>
                        <h4 class="text-xl font-bold mt-6 mb-2">票务详情</h4>
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="text-left py-2 px-4">票种</th>
                                    <th class="text-left py-2 px-4">数量</th>
                                    <th class="text-left py-2 px-4">单价</th>
                                    <th class="text-left py-2 px-4">小计</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${detailsHtml}
                            </tbody>
                        </table>
                    </div>
                `;
            })
            .catch(error => {
                modalContent.innerHTML = `
                    <div class="p-6">
                        <div class="flex justify-between items-start">
                             <h3 class="text-2xl font-bold mb-4">错误</h3>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">&times;</button>
                        </div>
                        <p>无法加载预定详情: ${error.message}</p>
                    </div>
                `;
            });
    }

    function closeModal() {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        modalContent.innerHTML = '<div class="p-8 text-center"><p>正在加载...</p></div>'; // Reset content
    }

    // Close modal on escape key press
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
            closeModal();
        }
    });

    // Close modal on outside click
    modal.addEventListener('click', (event) => {
        if (event.target === modal) {
            closeModal();
        }
    });
</script>
{% endblock %}