{% extends "base.html" %}
{% block title %}我的预约{% endblock %}

{% block content %}
<div class="container mx-auto p-8 pt-24" data-aos="fade-up">
    <h1 class="text-4xl font-playfair-display text-center mb-12">查询您的预定</h1>
    
    <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg">
        <form id="find-booking-form">
            <label for="booking_code" class="block text-gray-700 text-sm font-bold mb-2">请输入您的预定码:</label>
            <input type="text" id="booking_code" name="booking_code" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-4" required>
            <button type="submit" class="w-full aurora-btn bg-teal-500 text-white font-bold py-3 px-6 rounded-full text-lg transition-transform transform hover:scale-105">
                查询预定
            </button>
        </form>
    </div>

    <div id="booking-details" class="max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-lg mt-8 hidden">
        <!-- Booking details will be injected here by JavaScript -->
    </div>
</div>

<script>
document.getElementById('find-booking-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const code = document.getElementById('booking_code').value.trim();
    const detailsContainer = document.getElementById('booking-details');

    if (!code) {
        detailsContainer.innerHTML = `<p class="text-red-500 text-center">请输入预定码。</p>`;
        detailsContainer.classList.remove('hidden');
        return;
    }

    fetch(`/api/booking/${code}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('未找到预定信息');
            }
            return response.json();
        })
        .then(data => {
            let detailsHtml = `
                <h2 class="text-3xl font-playfair-display text-center mb-6">查询结果</h2>
                <div class="space-y-3">
                    <p><strong>预定码:</strong> <span class="font-mono">${data.booking_code}</span></p>
                    <p><strong>姓名:</strong> ${data.name}</p>
                    <p><strong>邮箱:</strong> ${data.email}</p>
                    <p><strong>参观日期:</strong> ${new Date(data.booking_date).toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                </div>
                <hr class="my-6">
                <h3 class="text-xl font-bold mb-4">门票详情:</h3>
                <ul class="space-y-2">`;

            data.details.forEach(item => {
                detailsHtml += `<li class="flex justify-between"><span>${item.quantity} x ${item.ticket_name}</span> <span>¥${(item.quantity * item.price * 7).toFixed(2)}</span></li>`;
            });

            detailsHtml += `
                </ul>
                <div class="text-right font-bold text-xl mt-4">
                    总计: ¥${(data.total_price * 7).toFixed(2)}
                </div>
            `;
            detailsContainer.innerHTML = detailsHtml;
        })
        .catch(error => {
            detailsContainer.innerHTML = `<p class="text-red-500 text-center">${error.message}，请检查您的预定码后重试。</p>`;
        })
        .finally(() => {
            detailsContainer.classList.remove('hidden');
        });
});
</script>
{% endblock %}